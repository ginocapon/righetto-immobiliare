<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin â€” Righetto Immobiliare</title>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@300;400;500;600;700&family=Montserrat:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
:root {
  --nero:   #3A5578;
  --nero2:  #4A6A8C;
  --caffe:  #5C7A9E;
  --caffe2: #7A9AB8;
  --caffe3: #A8C0D6;
  --oro:    #CEE08F;
  --oro2:   #e2efb8;
  --sfondo: #f5f0e8;
  --bianco: #fafaf5;
  --testo:  #1E3A5C;
  --rosso:  #e74c3c;
  --verde:  #27ae60;
  --sidebar-w: 260px;
}

* { margin:0; padding:0; box-sizing:border-box; }

body {
  font-family: 'Montserrat', sans-serif;
  background: var(--sfondo);
  color: var(--testo);
  min-height: 100vh;
}

/* â•â•â•â•â•â•â•â•â•â• LOGIN OVERLAY â•â•â•â•â•â•â•â•â•â• */
#loginOverlay {
  position: fixed; inset: 0;
  background: linear-gradient(135deg, var(--nero) 0%, var(--caffe) 100%);
  display: flex; align-items: center; justify-content: center;
  z-index: 9999;
}
.login-box {
  background: var(--bianco);
  border-radius: 16px;
  padding: 48px 40px;
  width: 100%; max-width: 420px;
  box-shadow: 0 24px 80px rgba(0,0,0,0.3);
  text-align: center;
}
.login-logo {
  font-family: 'Cormorant Garamond', serif;
  font-size: 2rem;
  font-weight: 600;
  color: var(--nero);
  margin-bottom: 6px;
}
.login-sub {
  font-size: 0.75rem;
  color: var(--caffe2);
  letter-spacing: 2px;
  text-transform: uppercase;
  margin-bottom: 32px;
}
.login-box input {
  width: 100%;
  padding: 14px 18px;
  border: 2px solid var(--caffe3);
  border-radius: 8px;
  font-family: 'Montserrat', sans-serif;
  font-size: 1rem;
  color: var(--testo);
  background: var(--sfondo);
  margin-bottom: 16px;
  transition: border-color 0.2s;
}
.login-box input:focus {
  outline: none;
  border-color: var(--nero);
}
.btn-login {
  width: 100%;
  padding: 14px;
  background: var(--oro);
  color: var(--testo);
  font-family: 'Montserrat', sans-serif;
  font-weight: 600;
  font-size: 0.9rem;
  letter-spacing: 1px;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  transition: background 0.2s;
}
.btn-login:hover { background: var(--oro2); }
.login-error {
  color: var(--rosso);
  font-size: 0.82rem;
  margin-top: 12px;
  display: none;
}

/* â•â•â•â•â•â•â•â•â•â• LAYOUT â•â•â•â•â•â•â•â•â•â• */
#appWrapper { display: flex; min-height: 100vh; }

/* SIDEBAR */
.sidebar {
  width: var(--sidebar-w);
  background: var(--nero);
  color: white;
  display: flex;
  flex-direction: column;
  position: fixed;
  top: 0; left: 0; bottom: 0;
  z-index: 100;
  transition: transform 0.3s;
}
.sidebar-logo {
  padding: 28px 24px 20px;
  border-bottom: 1px solid rgba(255,255,255,0.1);
}
.sidebar-logo h1 {
  font-family: 'Cormorant Garamond', serif;
  font-size: 1.3rem;
  font-weight: 600;
  color: var(--oro);
  line-height: 1.2;
}
.sidebar-logo span {
  font-size: 0.65rem;
  letter-spacing: 2px;
  text-transform: uppercase;
  color: var(--caffe3);
}
nav { flex: 1; padding: 16px 0; }
.nav-item {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 13px 24px;
  color: var(--caffe3);
  cursor: pointer;
  font-size: 0.85rem;
  font-weight: 500;
  transition: all 0.2s;
  border-left: 3px solid transparent;
  position: relative;
}
.nav-item:hover {
  color: white;
  background: rgba(255,255,255,0.06);
}
.nav-item.active {
  color: var(--oro);
  background: rgba(206,224,143,0.1);
  border-left-color: var(--oro);
}
.nav-item svg { width: 18px; height: 18px; flex-shrink: 0; }
.nav-badge {
  position: absolute;
  right: 16px;
  background: var(--rosso);
  color: white;
  font-size: 0.7rem;
  font-weight: 700;
  padding: 2px 7px;
  border-radius: 10px;
}
.sidebar-footer {
  padding: 16px 24px;
  border-top: 1px solid rgba(255,255,255,0.1);
  font-size: 0.75rem;
  color: var(--caffe3);
}
.btn-logout {
  display: flex; align-items: center; gap: 8px;
  color: var(--caffe3);
  cursor: pointer;
  font-size: 0.8rem;
  background: none;
  border: none;
  font-family: 'Montserrat', sans-serif;
  padding: 8px 0;
  transition: color 0.2s;
}
.btn-logout:hover { color: var(--oro); }

/* MAIN */
.main {
  margin-left: var(--sidebar-w);
  flex: 1;
  display: flex;
  flex-direction: column;
  min-height: 100vh;
}
.topbar {
  background: white;
  padding: 16px 32px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  border-bottom: 1px solid rgba(0,0,0,0.06);
  position: sticky; top: 0; z-index: 50;
  box-shadow: 0 2px 8px rgba(0,0,0,0.04);
}
.topbar-title {
  font-family: 'Cormorant Garamond', serif;
  font-size: 1.5rem;
  font-weight: 600;
  color: var(--nero);
}
.topbar-actions { display: flex; gap: 12px; align-items: center; }

.content { padding: 32px; flex: 1; }

/* â•â•â•â•â•â•â•â•â•â• BUTTONS â•â•â•â•â•â•â•â•â•â• */
.btn {
  display: inline-flex; align-items: center; gap: 8px;
  padding: 10px 20px;
  border-radius: 8px;
  font-family: 'Montserrat', sans-serif;
  font-size: 0.83rem;
  font-weight: 600;
  cursor: pointer;
  border: none;
  transition: all 0.2s;
  text-decoration: none;
}
.btn-primary { background: var(--oro); color: var(--testo); }
.btn-primary:hover { background: var(--oro2); transform: translateY(-1px); }
.btn-secondary { background: var(--caffe3); color: var(--testo); }
.btn-secondary:hover { background: var(--caffe2); color: white; }
.btn-danger { background: #fde8e8; color: var(--rosso); }
.btn-danger:hover { background: var(--rosso); color: white; }
.btn-sm { padding: 6px 12px; font-size: 0.75rem; }
.btn-icon { padding: 8px; border-radius: 6px; background: var(--sfondo); color: var(--testo); border: none; cursor: pointer; transition: all 0.2s; }
.btn-icon:hover { background: var(--caffe3); }

/* â•â•â•â•â•â•â•â•â•â• STATS â•â•â•â•â•â•â•â•â•â• */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
  gap: 16px;
  margin-bottom: 32px;
}
.stat-card {
  background: white;
  border-radius: 12px;
  padding: 20px 24px;
  border-left: 4px solid var(--oro);
  box-shadow: 0 2px 12px rgba(0,0,0,0.04);
}
.stat-card.blue { border-left-color: var(--caffe); }
.stat-card.green { border-left-color: var(--verde); }
.stat-card.red { border-left-color: var(--rosso); }
.stat-num {
  font-family: 'Cormorant Garamond', serif;
  font-size: 2.4rem;
  font-weight: 700;
  color: var(--nero);
  line-height: 1;
}
.stat-label {
  font-size: 0.75rem;
  color: var(--caffe2);
  text-transform: uppercase;
  letter-spacing: 1px;
  margin-top: 4px;
}

/* â•â•â•â•â•â•â•â•â•â• TABLE â•â•â•â•â•â•â•â•â•â• */
.table-wrap {
  background: white;
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 2px 12px rgba(0,0,0,0.04);
}
.table-head {
  padding: 16px 24px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  border-bottom: 1px solid var(--sfondo);
  gap: 12px;
  flex-wrap: wrap;
}
.table-search {
  padding: 9px 14px;
  border: 1.5px solid var(--caffe3);
  border-radius: 8px;
  font-family: 'Montserrat', sans-serif;
  font-size: 0.83rem;
  color: var(--testo);
  background: var(--sfondo);
  width: 240px;
  transition: border-color 0.2s;
}
.table-search:focus { outline: none; border-color: var(--nero); }

table { width: 100%; border-collapse: collapse; }
th {
  text-align: left;
  padding: 12px 16px;
  font-size: 0.72rem;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 1px;
  color: var(--caffe2);
  background: var(--sfondo);
  border-bottom: 1px solid rgba(0,0,0,0.06);
}
td {
  padding: 14px 16px;
  font-size: 0.82rem;
  border-bottom: 1px solid rgba(0,0,0,0.04);
  vertical-align: middle;
}
tr:last-child td { border-bottom: none; }
tr:hover td { background: rgba(206,224,143,0.06); }

.prop-thumb {
  width: 52px; height: 40px;
  border-radius: 6px;
  object-fit: cover;
  background: var(--caffe3);
  display: block;
}
.prop-thumb-placeholder {
  width: 52px; height: 40px;
  border-radius: 6px;
  background: var(--caffe3);
  display: flex; align-items: center; justify-content: center;
  color: white; font-size: 0.7rem;
}

/* BADGES */
.badge {
  display: inline-block;
  padding: 3px 10px;
  border-radius: 20px;
  font-size: 0.7rem;
  font-weight: 600;
}
.badge-verde { background: #d4f5e0; color: #1a7a40; }
.badge-rosso { background: #fde8e8; color: #c0392b; }
.badge-oro { background: #fef9e0; color: #7d6608; }
.badge-grigio { background: #eee; color: #666; }
.badge-blu { background: #e0eeff; color: #1a4a8a; }

/* TOGGLE */
.toggle {
  position: relative;
  display: inline-block;
  width: 36px; height: 20px;
}
.toggle input { display: none; }
.toggle-slider {
  position: absolute; inset: 0;
  background: #ccc;
  border-radius: 20px;
  cursor: pointer;
  transition: 0.2s;
}
.toggle-slider:before {
  content: '';
  position: absolute;
  width: 14px; height: 14px;
  left: 3px; top: 3px;
  background: white;
  border-radius: 50%;
  transition: 0.2s;
}
.toggle input:checked + .toggle-slider { background: var(--verde); }
.toggle input:checked + .toggle-slider:before { transform: translateX(16px); }

/* â•â•â•â•â•â•â•â•â•â• FORM / MODAL â•â•â•â•â•â•â•â•â•â• */
.modal-overlay {
  position: fixed; inset: 0;
  background: rgba(30,58,92,0.5);
  backdrop-filter: blur(4px);
  z-index: 500;
  display: none;
  align-items: flex-start;
  justify-content: center;
  padding: 24px;
  overflow-y: auto;
}
.modal-overlay.open { display: flex; }
.modal {
  background: white;
  border-radius: 16px;
  width: 100%; max-width: 860px;
  box-shadow: 0 24px 80px rgba(0,0,0,0.2);
  overflow: hidden;
  margin: auto;
}
.modal-header {
  padding: 24px 28px;
  background: var(--nero);
  color: white;
  display: flex;
  align-items: center;
  justify-content: space-between;
}
.modal-header h2 {
  font-family: 'Cormorant Garamond', serif;
  font-size: 1.4rem;
  font-weight: 500;
}
.modal-close {
  background: rgba(255,255,255,0.15);
  border: none;
  color: white;
  width: 32px; height: 32px;
  border-radius: 8px;
  cursor: pointer;
  font-size: 1.2rem;
  display: flex; align-items: center; justify-content: center;
  transition: background 0.2s;
}
.modal-close:hover { background: rgba(255,255,255,0.25); }
.modal-body { padding: 28px; }
.modal-footer {
  padding: 16px 28px;
  border-top: 1px solid var(--sfondo);
  display: flex;
  gap: 12px;
  justify-content: flex-end;
}

/* FORM */
.form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
.form-grid.three { grid-template-columns: 1fr 1fr 1fr; }
.form-full { grid-column: 1 / -1; }
.form-group { display: flex; flex-direction: column; gap: 6px; }
.form-group label {
  font-size: 0.72rem;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.8px;
  color: var(--caffe2);
}
.form-group input,
.form-group select,
.form-group textarea {
  padding: 10px 14px;
  border: 1.5px solid var(--caffe3);
  border-radius: 8px;
  font-family: 'Montserrat', sans-serif;
  font-size: 0.85rem;
  color: var(--testo);
  background: var(--sfondo);
  transition: border-color 0.2s;
}
.form-group input:focus,
.form-group select:focus,
.form-group textarea:focus {
  outline: none;
  border-color: var(--nero);
  background: white;
}
.form-group textarea { resize: vertical; min-height: 80px; }

.section-divider {
  font-family: 'Cormorant Garamond', serif;
  font-size: 1.1rem;
  font-weight: 600;
  color: var(--nero);
  margin: 20px 0 12px;
  padding-bottom: 8px;
  border-bottom: 2px solid var(--oro);
  grid-column: 1 / -1;
}

/* CHECKBOXES */
.checks-grid {
  display: flex; flex-wrap: wrap; gap: 10px;
  grid-column: 1 / -1;
}
.check-item {
  display: flex; align-items: center; gap: 7px;
  font-size: 0.82rem; cursor: pointer;
  background: var(--sfondo);
  padding: 7px 12px;
  border-radius: 8px;
  border: 1.5px solid transparent;
  transition: all 0.2s;
}
.check-item input { accent-color: var(--nero); }
.check-item:has(input:checked) {
  border-color: var(--oro);
  background: rgba(206,224,143,0.2);
}

/* FOTO MANAGER */
.foto-list {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
  gap: 10px;
  margin-top: 10px;
}
.foto-item {
  position: relative;
  border-radius: 8px;
  overflow: hidden;
  aspect-ratio: 4/3;
  background: var(--caffe3);
}
.foto-item img {
  width: 100%; height: 100%;
  object-fit: cover;
}
.foto-del {
  position: absolute; top: 4px; right: 4px;
  background: rgba(231,76,60,0.85);
  color: white; border: none;
  width: 22px; height: 22px;
  border-radius: 4px;
  cursor: pointer; font-size: 0.7rem;
  display: flex; align-items: center; justify-content: center;
}
.foto-add {
  display: flex; flex-direction: column;
  align-items: center; justify-content: center;
  gap: 6px;
  aspect-ratio: 4/3;
  border: 2px dashed var(--caffe3);
  border-radius: 8px;
  cursor: pointer;
  color: var(--caffe2);
  font-size: 0.75rem;
  text-align: center;
  padding: 8px;
  transition: all 0.2s;
}
.foto-add:hover { border-color: var(--nero); color: var(--nero); }
.url-input-row {
  display: flex; gap: 8px;
}
.url-input-row input { flex: 1; }

/* RICHIESTE */
.richiesta-card {
  background: white;
  border-radius: 10px;
  padding: 16px 20px;
  border-left: 4px solid var(--caffe);
  box-shadow: 0 2px 8px rgba(0,0,0,0.04);
  margin-bottom: 12px;
  display: flex;
  align-items: flex-start;
  justify-content: space-between;
  gap: 16px;
}
.richiesta-card.non-letta { border-left-color: var(--oro); }
.richiesta-info h4 { font-size: 0.9rem; font-weight: 600; color: var(--nero); }
.richiesta-info p { font-size: 0.8rem; color: var(--caffe2); margin-top: 2px; }
.richiesta-meta { font-size: 0.72rem; color: var(--caffe3); margin-top: 6px; }
.richiesta-actions { display: flex; gap: 8px; align-items: center; flex-shrink: 0; }

/* LOADING */
.loading {
  display: flex; align-items: center; justify-content: center;
  padding: 60px;
  color: var(--caffe2);
  font-size: 0.85rem;
  gap: 12px;
}
.spinner {
  width: 24px; height: 24px;
  border: 3px solid var(--caffe3);
  border-top-color: var(--nero);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }

.empty-state {
  text-align: center;
  padding: 60px 20px;
  color: var(--caffe2);
}
.empty-state svg { width: 48px; height: 48px; margin: 0 auto 12px; display: block; opacity: 0.4; }
.empty-state h3 { font-family: 'Cormorant Garamond', serif; font-size: 1.3rem; color: var(--nero); }

/* TOAST */
.toast-container {
  position: fixed;
  bottom: 24px; right: 24px;
  z-index: 9998;
  display: flex; flex-direction: column; gap: 8px;
}
.toast {
  background: var(--nero);
  color: white;
  padding: 12px 20px;
  border-radius: 8px;
  font-size: 0.83rem;
  box-shadow: 0 8px 24px rgba(0,0,0,0.2);
  animation: slideIn 0.3s ease;
  display: flex; align-items: center; gap: 10px;
}
.toast.success { background: var(--verde); }
.toast.error { background: var(--rosso); }
@keyframes slideIn { from { transform: translateX(100px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

/* SEZIONI */
.section { display: none; }
.section.active { display: block; }

/* FILTRI */
.filter-bar {
  background: white;
  border-radius: 10px;
  padding: 16px 20px;
  margin-bottom: 20px;
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
  align-items: center;
  box-shadow: 0 2px 8px rgba(0,0,0,0.04);
}
.filter-bar select, .filter-bar input {
  padding: 8px 12px;
  border: 1.5px solid var(--caffe3);
  border-radius: 8px;
  font-family: 'Montserrat', sans-serif;
  font-size: 0.8rem;
  color: var(--testo);
  background: var(--sfondo);
}

@media (max-width: 768px) {
  .sidebar { transform: translateX(-100%); }
  .sidebar.open { transform: translateX(0); }
  .main { margin-left: 0; }
  .content { padding: 16px; }
  .form-grid { grid-template-columns: 1fr; }
  .form-grid.three { grid-template-columns: 1fr; }
  table { font-size: 0.75rem; }
  td, th { padding: 10px 10px; }
}
</style>
</head>
<body>

<!-- LOGIN -->
<div id="loginOverlay">
  <div class="login-box">
    <div class="login-logo">Righetto Immobiliare</div>
    <div class="login-sub">Pannello Amministrazione</div>
    <input type="password" id="loginPass" placeholder="Password admin..." autocomplete="current-password">
    <button class="btn-login" onclick="doLogin()">Accedi</button>
    <div class="login-error" id="loginError">Password non corretta</div>
  </div>
</div>

<!-- APP -->
<div id="appWrapper" style="display:none">

  <!-- SIDEBAR -->
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-logo">
      <h1>Righetto<br>Immobiliare</h1>
      <span>Admin Panel</span>
    </div>
    <nav>
      <div class="nav-item active" onclick="showSection('immobili')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
        Immobili
      </div>
      <div class="nav-item" onclick="showSection('nuovo')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></svg>
        Nuovo Immobile
      </div>
      <div class="nav-item" onclick="showSection('richieste')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
        Richieste
        <span class="nav-badge" id="badgeRichieste" style="display:none">0</span>
      </div>
      <div class="nav-item" onclick="showSection('impostazioni')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
        Impostazioni
      </div>
    </nav>
    <div class="sidebar-footer">
      <button class="btn-logout" onclick="doLogout()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
        Logout
      </button>
    </div>
  </aside>

  <!-- MAIN -->
  <main class="main">
    <div class="topbar">
      <div class="topbar-title" id="topbarTitle">Gestione Immobili</div>
      <div class="topbar-actions">
        <a href="immobili.html" target="_blank" class="btn btn-secondary btn-sm">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>
          Vedi sito
        </a>
        <button class="btn btn-primary btn-sm" onclick="showSection('nuovo')">
          + Nuovo
        </button>
      </div>
    </div>

    <div class="content">

      <!-- â•â•â• SEZIONE IMMOBILI â•â•â• -->
      <div class="section active" id="sec-immobili">
        <div class="stats-grid" id="statsGrid">
          <div class="stat-card"><div class="stat-num" id="statTot">â€”</div><div class="stat-label">Totale Immobili</div></div>
          <div class="stat-card blue"><div class="stat-num" id="statVendita">â€”</div><div class="stat-label">In Vendita</div></div>
          <div class="stat-card green"><div class="stat-num" id="statAffitto">â€”</div><div class="stat-label">In Affitto</div></div>
          <div class="stat-card red"><div class="stat-num" id="statVenduti">â€”</div><div class="stat-label">Venduti/Affittati</div></div>
        </div>

        <div class="table-wrap">
          <div class="table-head">
            <div style="font-weight:600;font-size:0.9rem;">Lista Immobili</div>
            <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
              <select id="filtroTipo" onchange="loadImmobili()" style="padding:8px 12px;border:1.5px solid var(--caffe3);border-radius:8px;font-family:'Montserrat',sans-serif;font-size:0.8rem;">
                <option value="">Tutti</option>
                <option value="vendita">Vendita</option>
                <option value="affitto">Affitto</option>
                <option value="asta">Asta</option>
              </select>
              <input class="table-search" type="text" placeholder="ğŸ” Cerca..." id="searchInput" oninput="filterTable()">
            </div>
          </div>
          <div id="immobiliTableWrap">
            <div class="loading"><div class="spinner"></div> Caricamento dal database...</div>
          </div>
        </div>
      </div>

      <!-- â•â•â• SEZIONE NUOVO/MODIFICA â•â•â• -->
      <div class="section" id="sec-nuovo">
        <div class="table-wrap">
          <div class="modal-header" style="border-radius:0">
            <h2 id="formTitle">Nuovo Immobile</h2>
            <button class="btn btn-primary btn-sm" onclick="openImportModal()" style="background:var(--oro);color:var(--testo)">
              ğŸ“¥ Importa da Idealista
            </button>
          </div>
          <div class="modal-body">
            <form id="immobileForm" onsubmit="saveImmobile(event)">
              <input type="hidden" id="editId">
              <div class="form-grid">

                <div class="section-divider">Informazioni Base</div>

                <div class="form-group">
                  <label>Codice Riferimento</label>
                  <input type="text" id="f_codice" placeholder="es. RIG001">
                </div>
                <div class="form-group">
                  <label>Titolo *</label>
                  <input type="text" id="f_titolo" placeholder="es. Appartamento luminoso centro" required>
                </div>
                <div class="form-group">
                  <label>Tipo Operazione *</label>
                  <select id="f_tipo_operazione" required>
                    <option value="">Seleziona...</option>
                    <option value="vendita">Vendita</option>
                    <option value="affitto">Affitto</option>
                    <option value="asta">Asta</option>
                  </select>
                </div>
                <div class="form-group">
                  <label>Categoria</label>
                  <select id="f_categoria">
                    <option value="residenziale">Residenziale</option>
                    <option value="commerciale">Commerciale</option>
                    <option value="terreno">Terreno</option>
                  </select>
                </div>
                <div class="form-group">
                  <label>Tipologia</label>
                  <select id="f_tipologia">
                    <option value="appartamento">Appartamento</option>
                    <option value="villa">Villa</option>
                    <option value="villetta">Villetta</option>
                    <option value="attico">Attico</option>
                    <option value="bilocale">Bilocale</option>
                    <option value="trilocale">Trilocale</option>
                    <option value="monolocale">Monolocale</option>
                    <option value="ufficio">Ufficio</option>
                    <option value="negozio">Negozio</option>
                    <option value="capannone">Capannone</option>
                    <option value="terreno">Terreno</option>
                    <option value="garage">Garage</option>
                  </select>
                </div>
                <div class="form-group">
                  <label>Prezzo (â‚¬) *</label>
                  <input type="number" id="f_prezzo" placeholder="es. 180000" required>
                </div>

                <div class="section-divider">Localizzazione</div>

                <div class="form-group">
                  <label>Comune</label>
                  <input type="text" id="f_comune" value="Padova" placeholder="Padova">
                </div>
                <div class="form-group form-full">
                  <label>Indirizzo</label>
                  <input type="text" id="f_indirizzo" placeholder="es. Via Roma 12, Padova">
                </div>
                <div class="form-group">
                  <label>Latitudine</label>
                  <input type="number" id="f_lat" step="any" placeholder="es. 45.4064">
                </div>
                <div class="form-group">
                  <label>Longitudine</label>
                  <input type="number" id="f_lng" step="any" placeholder="es. 11.8768">
                </div>

                <div class="section-divider">Caratteristiche</div>

                <div class="form-group">
                  <label>Superficie (mq)</label>
                  <input type="number" id="f_superficie" placeholder="es. 85">
                </div>
                <div class="form-group">
                  <label>Locali</label>
                  <input type="number" id="f_locali" placeholder="es. 3">
                </div>
                <div class="form-group">
                  <label>Bagni</label>
                  <input type="number" id="f_bagni" placeholder="es. 1">
                </div>
                <div class="form-group">
                  <label>Piano</label>
                  <input type="text" id="f_piano" placeholder="es. 2Â° / Terra / Ultimo">
                </div>
                <div class="form-group">
                  <label>Anno Costruzione</label>
                  <input type="number" id="f_anno_costruzione" placeholder="es. 1990">
                </div>
                <div class="form-group">
                  <label>Stato</label>
                  <select id="f_stato">
                    <option value="">Non specificato</option>
                    <option value="ottimo">Ottimo</option>
                    <option value="buono">Buono</option>
                    <option value="da_ristrutturare">Da ristrutturare</option>
                    <option value="ristrutturato">Ristrutturato</option>
                    <option value="nuovo">Nuovo</option>
                  </select>
                </div>
                <div class="form-group">
                  <label>Classe Energetica</label>
                  <select id="f_classe_energetica">
                    <option value="">Non specificata</option>
                    <option>A4</option><option>A3</option><option>A2</option><option>A1</option>
                    <option>B</option><option>C</option><option>D</option>
                    <option>E</option><option>F</option><option>G</option>
                  </select>
                </div>

                <div class="section-divider">Dotazioni</div>

                <div class="checks-grid">
                  <label class="check-item"><input type="checkbox" id="f_garage"> ğŸš— Garage</label>
                  <label class="check-item"><input type="checkbox" id="f_giardino"> ğŸŒ¿ Giardino</label>
                  <label class="check-item"><input type="checkbox" id="f_terrazzo"> â˜€ï¸ Terrazzo</label>
                  <label class="check-item"><input type="checkbox" id="f_cantina"> ğŸ“¦ Cantina</label>
                  <label class="check-item"><input type="checkbox" id="f_ascensore"> ğŸ›— Ascensore</label>
                  <label class="check-item"><input type="checkbox" id="f_piscina"> ğŸŠ Piscina</label>
                  <label class="check-item"><input type="checkbox" id="f_arredato"> ğŸ›‹ï¸ Arredato</label>
                </div>

                <div class="section-divider">Foto & Media</div>

                <div class="form-group form-full">
                  <label>Aggiungi URL Foto</label>
                  <div class="url-input-row">
                    <input type="url" id="fotoUrlInput" placeholder="https://... (URL immagine)">
                    <button type="button" class="btn btn-secondary btn-sm" onclick="addFoto()">+ Aggiungi</button>
                  </div>
                  <div class="foto-list" id="fotoList"></div>
                </div>

                <div class="form-group">
                  <label>YouTube Video ID</label>
                  <input type="text" id="f_youtube_id" placeholder="es. dQw4w9WgXcQ">
                </div>
                <div class="form-group">
                  <label>Virtual Tour URL (iframe)</label>
                  <input type="url" id="f_virtual_tour" placeholder="https://...">
                </div>
                <div class="form-group">
                  <label>Planimetria URL</label>
                  <input type="url" id="f_planimetria" placeholder="https://...">
                </div>

                <div class="section-divider">Stato Pubblicazione</div>

                <div class="checks-grid">
                  <label class="check-item"><input type="checkbox" id="f_attivo" checked> âœ… Attivo (visibile)</label>
                  <label class="check-item"><input type="checkbox" id="f_in_evidenza"> â­ In Evidenza</label>
                  <label class="check-item"><input type="checkbox" id="f_venduto"> ğŸ”´ Venduto</label>
                  <label class="check-item"><input type="checkbox" id="f_affittato"> ğŸ”´ Affittato</label>
                </div>

                <div class="section-divider">Note Interne</div>

                <div class="form-group">
                  <label>ID Idealista</label>
                  <input type="text" id="f_id_idealista" placeholder="ID annuncio su Idealista">
                </div>
                <div class="form-group form-full">
                  <label>Note Interne</label>
                  <textarea id="f_note_interne" placeholder="Note private, appunti, promemoria..."></textarea>
                </div>

              </div><!-- /form-grid -->

              <div style="display:flex;gap:12px;margin-top:24px;justify-content:flex-end;">
                <button type="button" class="btn btn-secondary" onclick="resetForm()">Annulla</button>
                <button type="submit" class="btn btn-primary" id="btnSalva">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
                  Salva Immobile
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>

      <!-- â•â•â• SEZIONE RICHIESTE â•â•â• -->
      <div class="section" id="sec-richieste">
        <div class="table-wrap" style="padding:24px">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
            <h3 style="font-family:'Cormorant Garamond',serif;font-size:1.3rem;">Richieste Ricevute</h3>
            <button class="btn btn-secondary btn-sm" onclick="loadRichieste()">â†º Aggiorna</button>
          </div>
          <div class="filter-bar">
            <select id="filtroRichiesteProvenienza" onchange="loadRichieste()">
              <option value="">Tutte le fonti</option>
              <option value="chatbot">Chatbot</option>
              <option value="form">Form Contatto</option>
              <option value="email">Email</option>
            </select>
            <select id="filtroRichiesteLetto" onchange="loadRichieste()">
              <option value="">Tutte</option>
              <option value="false">Non lette</option>
              <option value="true">Lette</option>
            </select>
          </div>
          <div id="richiesteList">
            <div class="loading"><div class="spinner"></div> Caricamento richieste...</div>
          </div>
        </div>
      </div>

      <!-- â•â•â• SEZIONE IMPOSTAZIONI â•â•â• -->
      <div class="section" id="sec-impostazioni">
        <div class="table-wrap" style="padding:28px;max-width:600px">
          <h3 style="font-family:'Cormorant Garamond',serif;font-size:1.4rem;margin-bottom:20px;">Impostazioni</h3>
          <div class="form-group" style="margin-bottom:16px">
            <label>Supabase URL</label>
            <input type="text" value="https://qwkwkemuabfwvwuqrxlu.supabase.co" readonly>
          </div>
          <div class="form-group" style="margin-bottom:16px">
            <label>Progetto</label>
            <input type="text" value="righetto-immobiliare" readonly>
          </div>
          <div class="form-group" style="margin-bottom:24px">
            <label>Stato Connessione</label>
            <input type="text" id="connStatus" value="Verifica in corso..." readonly>
          </div>
          <div style="display:flex;gap:12px">
            <button class="btn btn-secondary" onclick="testConn()">Test Connessione</button>
            <a href="https://supabase.com/dashboard/project/qwkwkemuabfwvwuqrxlu" target="_blank" class="btn btn-primary">Apri Supabase</a>
          </div>
        </div>
      </div>

    </div><!-- /content -->
  </main>
</div><!-- /appWrapper -->

<div class="toast-container" id="toastContainer"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONFIG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SUPABASE_URL = 'https://qwkwkemuabfwvwuqrxlu.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF3a3drZW11YWJmd3Z3dXFyeGx1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE1OTk5NjEsImV4cCI6MjA4NzE3NTk2MX0.JxEYiWVPEOiwjZtbWAZRlMUdKXcupjw7filvrERCiqc';
const ADMIN_PASSWORD = 'Righetto2024!';
const URL_KEY = 'RIG2024';

const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let currentFotos = [];
let allImmobili = [];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LOGIN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function checkAuth() {
  const params = new URLSearchParams(window.location.search);
  const urlKey = params.get('key');
  const session = sessionStorage.getItem('rig_admin');

  if (urlKey === URL_KEY || session === 'ok') {
    sessionStorage.setItem('rig_admin', 'ok');
    document.getElementById('loginOverlay').style.display = 'none';
    document.getElementById('appWrapper').style.display = 'flex';
    init();
  }
}

function doLogin() {
  const pass = document.getElementById('loginPass').value;
  if (pass === ADMIN_PASSWORD) {
    sessionStorage.setItem('rig_admin', 'ok');
    document.getElementById('loginOverlay').style.display = 'none';
    document.getElementById('appWrapper').style.display = 'flex';
    init();
  } else {
    document.getElementById('loginError').style.display = 'block';
    document.getElementById('loginPass').style.borderColor = 'var(--rosso)';
  }
}

document.getElementById('loginPass').addEventListener('keydown', e => {
  if (e.key === 'Enter') doLogin();
});

function doLogout() {
  sessionStorage.removeItem('rig_admin');
  location.reload();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function init() {
  await loadImmobili();
  await loadRichiesteCount();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NAVIGATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showSection(name) {
  document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  document.getElementById('sec-' + name).classList.add('active');
  event.currentTarget.classList.add('active');

  const titles = {
    immobili: 'Gestione Immobili',
    nuovo: 'Nuovo Immobile',
    richieste: 'Richieste Clienti',
    impostazioni: 'Impostazioni'
  };
  document.getElementById('topbarTitle').textContent = titles[name] || name;

  if (name === 'richieste') loadRichieste();
  if (name === 'impostazioni') testConn();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LOAD IMMOBILI
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadImmobili() {
  const wrap = document.getElementById('immobiliTableWrap');
  wrap.innerHTML = '<div class="loading"><div class="spinner"></div> Caricamento...</div>';

  const tipo = document.getElementById('filtroTipo').value;
  let query = sb.from('immobili').select('*').order('created_at', { ascending: false });
  if (tipo) query = query.eq('tipo_operazione', tipo);

  const { data, error } = await query;
  if (error) {
    wrap.innerHTML = `<div class="empty-state"><h3>Errore caricamento</h3><p style="margin-top:8px;font-size:0.8rem;color:var(--rosso)">${error.message}</p></div>`;
    return;
  }

  allImmobili = data || [];
  updateStats(allImmobili);
  renderTable(allImmobili);
}

function updateStats(data) {
  document.getElementById('statTot').textContent = data.length;
  document.getElementById('statVendita').textContent = data.filter(i => i.tipo_operazione === 'vendita' && !i.venduto).length;
  document.getElementById('statAffitto').textContent = data.filter(i => i.tipo_operazione === 'affitto' && !i.affittato).length;
  document.getElementById('statVenduti').textContent = data.filter(i => i.venduto || i.affittato).length;
}

function renderTable(data) {
  const wrap = document.getElementById('immobiliTableWrap');
  if (!data.length) {
    wrap.innerHTML = `<div class="empty-state">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/></svg>
      <h3>Nessun immobile trovato</h3>
      <p style="margin-top:8px;font-size:0.82rem">Aggiungi il primo immobile con il pulsante "Nuovo"</p>
    </div>`;
    return;
  }

  const rows = data.map(i => {
    const foto = Array.isArray(i.foto) && i.foto.length > 0 ? i.foto[0] : null;
    const thumb = foto
      ? `<img src="${foto}" class="prop-thumb" onerror="this.style.display='none'">`
      : `<div class="prop-thumb-placeholder">ğŸ“·</div>`;

    const stato = i.venduto ? `<span class="badge badge-rosso">Venduto</span>`
      : i.affittato ? `<span class="badge badge-rosso">Affittato</span>`
      : i.attivo ? `<span class="badge badge-verde">Attivo</span>`
      : `<span class="badge badge-grigio">Disattivo</span>`;

    const tipo = i.tipo_operazione === 'vendita' ? `<span class="badge badge-blu">Vendita</span>`
      : i.tipo_operazione === 'affitto' ? `<span class="badge badge-oro">Affitto</span>`
      : `<span class="badge badge-grigio">Asta</span>`;

    const evidenza = i.in_evidenza ? 'â­' : '';
    const prezzo = i.prezzo ? 'â‚¬ ' + Number(i.prezzo).toLocaleString('it-IT') : 'â€”';
    const mq = i.superficie ? i.superficie + ' mq' : 'â€”';

    return `<tr>
      <td>${thumb}</td>
      <td>
        <div style="font-weight:600;font-size:0.85rem">${evidenza} ${i.titolo || 'â€”'}</div>
        <div style="color:var(--caffe2);font-size:0.75rem">${i.codice || ''} Â· ${i.comune || 'Padova'}</div>
      </td>
      <td>${tipo}</td>
      <td style="font-weight:600">${prezzo}</td>
      <td>${mq}</td>
      <td>${i.locali || 'â€”'}</td>
      <td>${stato}</td>
      <td>
        <div style="display:flex;gap:6px">
          <button class="btn btn-secondary btn-sm" onclick='editImmobile(${JSON.stringify(i)})'>âœï¸</button>
          <button class="btn btn-danger btn-sm" onclick="deleteImmobile('${i.id}','${(i.titolo||'').replace(/'/g,"\\'")}')">ğŸ—‘ï¸</button>
          <button class="btn btn-sm" onclick="toggleEvidenza('${i.id}',${!i.in_evidenza})" title="Toggle evidenza" style="background:var(--sfondo)">â­</button>
          <button class="btn btn-sm" onclick="toggleAttivo('${i.id}',${!i.attivo})" title="Toggle attivo" style="background:var(--sfondo)">${i.attivo ? 'ğŸ‘ï¸' : 'ğŸš«'}</button>
        </div>
      </td>
    </tr>`;
  }).join('');

  wrap.innerHTML = `<table>
    <thead><tr>
      <th>Foto</th>
      <th>Immobile</th>
      <th>Tipo</th>
      <th>Prezzo</th>
      <th>Superficie</th>
      <th>Locali</th>
      <th>Stato</th>
      <th>Azioni</th>
    </tr></thead>
    <tbody>${rows}</tbody>
  </table>`;
}

function filterTable() {
  const q = document.getElementById('searchInput').value.toLowerCase();
  const filtered = allImmobili.filter(i =>
    (i.titolo || '').toLowerCase().includes(q) ||
    (i.codice || '').toLowerCase().includes(q) ||
    (i.comune || '').toLowerCase().includes(q) ||
    (i.indirizzo || '').toLowerCase().includes(q)
  );
  renderTable(filtered);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FORM / SAVE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function resetForm() {
  document.getElementById('immobileForm').reset();
  document.getElementById('editId').value = '';
  document.getElementById('formTitle').textContent = 'Nuovo Immobile';
  document.getElementById('f_attivo').checked = true;
  currentFotos = [];
  renderFotos();
  showSection('nuovo');
}

function editImmobile(imm) {
  document.getElementById('editId').value = imm.id;
  document.getElementById('formTitle').textContent = 'Modifica: ' + imm.titolo;

  const fields = ['codice','titolo','tipo_operazione','categoria','tipologia','prezzo',
    'comune','indirizzo','lat','lng','superficie','locali','bagni','piano',
    'anno_costruzione','stato','classe_energetica','youtube_id','virtual_tour',
    'planimetria','id_idealista','note_interne'];

  fields.forEach(f => {
    const el = document.getElementById('f_' + f);
    if (el) el.value = imm[f] !== null && imm[f] !== undefined ? imm[f] : '';
  });

  const bools = ['garage','giardino','terrazzo','cantina','ascensore','piscina','arredato','attivo','in_evidenza','venduto','affittato'];
  bools.forEach(f => {
    const el = document.getElementById('f_' + f);
    if (el) el.checked = !!imm[f];
  });

  currentFotos = Array.isArray(imm.foto) ? [...imm.foto] : [];
  renderFotos();

  // Switch to form section
  document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  document.getElementById('sec-nuovo').classList.add('active');
  document.getElementById('topbarTitle').textContent = 'Modifica Immobile';
  window.scrollTo(0, 0);
}

async function saveImmobile(e) {
  e.preventDefault();
  const btn = document.getElementById('btnSalva');
  btn.disabled = true;
  btn.innerHTML = '<div class="spinner" style="width:16px;height:16px;border-width:2px"></div> Salvataggio...';

  const id = document.getElementById('editId').value;
  const titolo = document.getElementById('f_titolo').value.trim();
  const slug = titolo.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g, '');

  const payload = {
    codice: document.getElementById('f_codice').value || null,
    titolo,
    slug,
    tipo_operazione: document.getElementById('f_tipo_operazione').value,
    categoria: document.getElementById('f_categoria').value,
    tipologia: document.getElementById('f_tipologia').value,
    prezzo: parseFloat(document.getElementById('f_prezzo').value) || null,
    comune: document.getElementById('f_comune').value || 'Padova',
    indirizzo: document.getElementById('f_indirizzo').value || null,
    lat: parseFloat(document.getElementById('f_lat').value) || null,
    lng: parseFloat(document.getElementById('f_lng').value) || null,
    superficie: parseInt(document.getElementById('f_superficie').value) || null,
    locali: parseInt(document.getElementById('f_locali').value) || null,
    bagni: parseInt(document.getElementById('f_bagni').value) || null,
    piano: document.getElementById('f_piano').value || null,
    anno_costruzione: parseInt(document.getElementById('f_anno_costruzione').value) || null,
    stato: document.getElementById('f_stato').value || null,
    classe_energetica: document.getElementById('f_classe_energetica').value || null,
    garage: document.getElementById('f_garage').checked,
    giardino: document.getElementById('f_giardino').checked,
    terrazzo: document.getElementById('f_terrazzo').checked,
    cantina: document.getElementById('f_cantina').checked,
    ascensore: document.getElementById('f_ascensore').checked,
    piscina: document.getElementById('f_piscina').checked,
    arredato: document.getElementById('f_arredato').checked,
    foto: currentFotos,
    youtube_id: document.getElementById('f_youtube_id').value || null,
    virtual_tour: document.getElementById('f_virtual_tour').value || null,
    planimetria: document.getElementById('f_planimetria').value || null,
    attivo: document.getElementById('f_attivo').checked,
    in_evidenza: document.getElementById('f_in_evidenza').checked,
    venduto: document.getElementById('f_venduto').checked,
    affittato: document.getElementById('f_affittato').checked,
    id_idealista: document.getElementById('f_id_idealista').value || null,
    note_interne: document.getElementById('f_note_interne').value || null,
  };

  let error;
  if (id) {
    ({ error } = await sb.from('immobili').update(payload).eq('id', id));
  } else {
    ({ error } = await sb.from('immobili').insert(payload));
  }

  btn.disabled = false;
  btn.innerHTML = 'ğŸ’¾ Salva Immobile';

  if (error) {
    toast('Errore: ' + error.message, 'error');
  } else {
    toast(id ? 'Immobile aggiornato!' : 'Immobile creato!', 'success');
    document.getElementById('editId').value = '';
    document.getElementById('formTitle').textContent = 'Nuovo Immobile';
    document.getElementById('immobileForm').reset();
    document.getElementById('f_attivo').checked = true;
    currentFotos = [];
    renderFotos();
    await loadImmobili();
    showSectionById('immobili');
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CRUD HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function deleteImmobile(id, titolo) {
  if (!confirm(`Eliminare definitivamente "${titolo}"?\n\nQuesta azione non Ã¨ reversibile.`)) return;
  const { error } = await sb.from('immobili').delete().eq('id', id);
  if (error) { toast('Errore: ' + error.message, 'error'); return; }
  toast('Immobile eliminato', 'success');
  await loadImmobili();
}

async function toggleEvidenza(id, val) {
  const { error } = await sb.from('immobili').update({ in_evidenza: val }).eq('id', id);
  if (!error) { await loadImmobili(); toast(val ? 'â­ In evidenza!' : 'Rimosso da evidenza'); }
}

async function toggleAttivo(id, val) {
  const { error } = await sb.from('immobili').update({ attivo: val }).eq('id', id);
  if (!error) { await loadImmobili(); toast(val ? 'âœ… Immobile attivato' : 'ğŸš« Immobile disattivato'); }
}

function showSectionById(name) {
  document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
  document.getElementById('sec-' + name).classList.add('active');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FOTO MANAGER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function addFoto() {
  const url = document.getElementById('fotoUrlInput').value.trim();
  if (!url) return;
  currentFotos.push(url);
  document.getElementById('fotoUrlInput').value = '';
  renderFotos();
}

function removeFoto(idx) {
  currentFotos.splice(idx, 1);
  renderFotos();
}

function renderFotos() {
  const list = document.getElementById('fotoList');
  list.innerHTML = currentFotos.map((url, i) => `
    <div class="foto-item">
      <img src="${url}" onerror="this.src='data:image/svg+xml,<svg xmlns=\'http://www.w3.org/2000/svg\' width=\'100\' height=\'75\'><rect fill=\'%23A8C0D6\'/><text x=\'50%25\' y=\'50%25\' text-anchor=\'middle\' dy=\'.3em\' fill=\'white\' font-size=\'10\'>Errore URL</text></svg>'">
      <button class="foto-del" onclick="removeFoto(${i})">âœ•</button>
    </div>
  `).join('') + `
    <div class="foto-add" onclick="document.getElementById('fotoUrlInput').focus()">
      <span style="font-size:1.5rem">+</span>
      <span>Aggiungi foto</span>
    </div>
  `;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RICHIESTE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadRichiesteCount() {
  const { count } = await sb.from('richieste').select('*', { count: 'exact', head: true }).eq('letto', false);
  const badge = document.getElementById('badgeRichieste');
  if (count > 0) {
    badge.textContent = count;
    badge.style.display = 'inline-block';
  } else {
    badge.style.display = 'none';
  }
}

async function loadRichieste() {
  const list = document.getElementById('richiesteList');
  list.innerHTML = '<div class="loading"><div class="spinner"></div> Caricamento...</div>';

  const prov = document.getElementById('filtroRichiesteProvenienza').value;
  const letto = document.getElementById('filtroRichiesteLetto').value;

  let query = sb.from('richieste').select('*').order('created_at', { ascending: false });
  if (prov) query = query.eq('provenienza', prov);
  if (letto !== '') query = query.eq('letto', letto === 'true');

  const { data, error } = await query;
  if (error) { list.innerHTML = `<p style="color:var(--rosso)">${error.message}</p>`; return; }

  if (!data || !data.length) {
    list.innerHTML = `<div class="empty-state">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
      <h3>Nessuna richiesta</h3>
    </div>`;
    return;
  }

  list.innerHTML = data.map(r => {
    const data_fmt = new Date(r.created_at).toLocaleString('it-IT');
    const prov_badge = r.provenienza === 'chatbot' ? `<span class="badge badge-blu">ğŸ¤– Chatbot</span>`
      : r.provenienza === 'form' ? `<span class="badge badge-verde">ğŸ“ Form</span>`
      : `<span class="badge badge-grigio">ğŸ“§ Email</span>`;

    return `<div class="richiesta-card ${r.letto ? '' : 'non-letta'}">
      <div class="richiesta-info">
        <h4>${r.nome || 'Anonimo'} ${r.letto ? '' : 'ğŸ”µ'}</h4>
        <p>ğŸ“§ ${r.email || 'â€”'} Â· ğŸ“ ${r.telefono || 'â€”'}</p>
        ${r.messaggio ? `<p style="margin-top:6px;color:var(--testo)">${r.messaggio}</p>` : ''}
        ${r.tipo_immobile ? `<p>ğŸ  Cerca: ${r.tipo_immobile} Â· Budget: ${r.budget || 'â€”'} Â· Zona: ${r.zona || 'â€”'}</p>` : ''}
        <div class="richiesta-meta">${prov_badge} Â· ${data_fmt}</div>
      </div>
      <div class="richiesta-actions">
        ${!r.letto ? `<button class="btn btn-secondary btn-sm" onclick="segnaLetta('${r.id}')">âœ“ Segna letta</button>` : ''}
        <button class="btn btn-danger btn-sm" onclick="deleteRichiesta('${r.id}')">ğŸ—‘ï¸</button>
      </div>
    </div>`;
  }).join('');
}

async function segnaLetta(id) {
  await sb.from('richieste').update({ letto: true }).eq('id', id);
  loadRichieste();
  loadRichiesteCount();
}

async function deleteRichiesta(id) {
  if (!confirm('Eliminare questa richiesta?')) return;
  await sb.from('richieste').delete().eq('id', id);
  loadRichieste();
  loadRichiesteCount();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TEST CONNESSIONE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function testConn() {
  const el = document.getElementById('connStatus');
  el.value = 'Verifica in corso...';
  const { count, error } = await sb.from('immobili').select('*', { count: 'exact', head: true });
  if (error) {
    el.value = 'âŒ Errore: ' + error.message;
  } else {
    el.value = `âœ… Connesso â€” ${count} immobili nel database`;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TOAST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toast(msg, type = '') {
  const c = document.getElementById('toastContainer');
  const t = document.createElement('div');
  t.className = 'toast ' + type;
  t.textContent = msg;
  c.appendChild(t);
  setTimeout(() => t.remove(), 3500);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// START
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// IMPORTA DA IDEALISTA
function openImportModal() {
  document.getElementById('importModal').classList.add('open');
  document.getElementById('importJson').value = '';
  document.getElementById('importError').style.display = 'none';
}
function closeImportModal() {
  document.getElementById('importModal').classList.remove('open');
}
function doImport() {
  const raw = document.getElementById('importJson').value.trim();
  const errEl = document.getElementById('importError');
  errEl.style.display = 'none';
  if (!raw) { errEl.textContent = 'âš ï¸ Incolla il JSON!'; errEl.style.display = 'block'; return; }
  let data;
  try { data = JSON.parse(raw); } catch(e) { errEl.textContent = 'âŒ JSON non valido. Riprova.'; errEl.style.display = 'block'; return; }
  const map = {codice:'f_codice',titolo:'f_titolo',tipo_operazione:'f_tipo_operazione',categoria:'f_categoria',tipologia:'f_tipologia',comune:'f_comune',indirizzo:'f_indirizzo',prezzo:'f_prezzo',superficie:'f_superficie',locali:'f_locali',bagni:'f_bagni',piano:'f_piano',anno_costruzione:'f_anno_costruzione',stato:'f_stato',classe_energetica:'f_classe_energetica',youtube_id:'f_youtube_id',virtual_tour:'f_virtual_tour',planimetria:'f_planimetria',id_idealista:'f_id_idealista',note_interne:'f_note_interne',lat:'f_lat',lng:'f_lng'};
  Object.entries(map).forEach(([k,id])=>{const el=document.getElementById(id);if(el&&data[k]!==undefined&&data[k]!==null)el.value=data[k];});
  ['garage','giardino','terrazzo','cantina','ascensore','piscina','arredato','attivo','in_evidenza','venduto','affittato'].forEach(k=>{const el=document.getElementById('f_'+k);if(el&&data[k]!==undefined)el.checked=!!data[k];});
  if(Array.isArray(data.foto)&&data.foto.length>0){currentFotos=[...data.foto];renderFotos();}
  document.getElementById('f_attivo').checked=true;
  closeImportModal();
  toast('âœ… '+(data.foto?.length||0)+' foto + dati importati!','success');
  window.scrollTo(0,200);
}

renderFotos();
checkAuth();
</script>

<!-- MODAL IMPORTA DA IDEALISTA -->
<div class="modal-overlay" id="importModal">
  <div class="modal" style="max-width:600px">
    <div class="modal-header">
      <h2>ğŸ“¥ Importa da Idealista</h2>
      <button class="modal-close" onclick="closeImportModal()">âœ•</button>
    </div>
    <div class="modal-body">
      <p style="font-size:0.85rem;color:var(--caffe2);margin-bottom:16px">
        1ï¸âƒ£ Apri annuncio su Idealista<br>
        2ï¸âƒ£ Premi <strong>F12</strong> â†’ tab <strong>Console</strong><br>
        3ï¸âƒ£ Incolla il bookmarklet e premi Invio<br>
        4ï¸âƒ£ Copia il JSON che appare qui sotto
      </p>
      <div class="form-group">
        <label>Incolla qui il JSON copiato dal bookmarklet</label>
        <textarea id="importJson" style="min-height:200px;font-family:monospace;font-size:0.75rem" placeholder='{
  "titolo": "...",
  "prezzo": 180000,
  ...
}'></textarea>
      </div>
      <div id="importError" style="color:var(--rosso);font-size:0.82rem;margin-top:8px;display:none"></div>
      <div style="background:var(--sfondo);border-radius:8px;padding:12px;margin-top:12px">
        <div style="font-size:0.75rem;font-weight:600;color:var(--caffe2);margin-bottom:8px">BOOKMARKLET â€” salva nei preferiti del browser:</div>
        <code style="font-size:0.68rem;word-break:break-all;color:var(--nero)">javascript:(function(){const cfg=window.config||{};const mm=window.adMultimediasInfo||{};const id=String(cfg.propertyId||"");const op=cfg.operation||"";const tipo=op==="rent"?"affitto":op==="sale"?"vendita":"asta";const titolo=document.querySelector(".main-info__title-main")?.textContent?.trim()||"?";const comune=document.querySelector(".main-info__title-minor")?.textContent?.trim()||"Padova";const prezzo_txt=document.querySelector(".info-data-price .txt-bold")?.textContent?.trim()||"0";const prezzo=parseFloat(prezzo_txt.replace(/\./g,"").replace(",","."))||null;const chars=[...document.querySelectorAll(".details-property_features li")].map(li=>li.textContent.trim());const desc=document.querySelector(".comment .adCommentsLanguage p")?.textContent?.trim()||"?";const tipologie={warehouse:"capannone",apartment:"appartamento",villa:"villa",penthouse:"attico",office:"ufficio",store:"negozio",garage:"garage"};const tipologia=tipologie[cfg.typology||"?"]||cfg.typology||"?";const categoria=["warehouse","office","store"].includes(cfg.typology)?"commerciale":"residenziale";let foto=[];try{const pics=cfg.multimediaCarrousel?.multimedias?.find(m=>m.type==="PICTURE")?.content||[];foto=pics.map(p=>p.src||p.imageDataService).filter(Boolean);}catch(e){foto=(mm.picturesWithoutPlans||[]).map(p=>p.imageDataService).filter(Boolean);}const codice=document.querySelector(".txt-ref")?.textContent?.trim()||"RIG"+id.slice(-4);const feats=[...document.querySelectorAll(".info-features span")].map(s=>s.textContent.trim());const sup=parseInt(feats.find(f=>f.match(/^\d/))||"0")||null;const dl=desc.toLowerCase();const r={codice,titolo,tipo_operazione:tipo,categoria,tipologia,comune,prezzo,superficie:sup,foto,garage:dl.includes("garage")||dl.includes("parcheggio"),giardino:dl.includes("giardino"),terrazzo:dl.includes("terraz"),ascensore:dl.includes("ascensore"),piscina:dl.includes("piscina"),arredato:dl.includes("arredato"),id_idealista:id,note_interne:desc.substring(0,500),attivo:true,in_evidenza:false,venduto:false,affittato:false};const json=JSON.stringify(r,null,2);console.log("%câœ… DATI ESTRATTI:","background:#CEE08F;color:#1E3A5C;font-size:14px;font-weight:bold");console.log(json);navigator.clipboard.writeText(json).then(()=>alert("âœ… "+foto.length+" foto + dati copiati!

Vai Admin â†’ Nuovo â†’ Importa da Idealista")).catch(()=>alert("Apri Console F12 e copia il JSON"));})();</code>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeImportModal()">Annulla</button>
      <button class="btn btn-primary" onclick="doImport()">âœ… Compila il form</button>
    </div>
  </div>
</div>
</body>
</html>
